<sequence xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		disabled="false"
		id="26ee3fa1-7ea7-46c4-ab94-607a20b08957"
		lineNumber="1">
	<steps xsi:type="be.nabu.libs.services.vm.step.Map"
			comment="Add $any, the server name, the server group and the server aliases"
			disabled="false"
			id="89df3f61fbc940cb8736369f000c18a7"
			label="!input/targets"
			lineNumber="2">
		<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
				disabled="false"
				id="6e1acaea-efd6-484a-b82b-3795fbd3a50d"
				serviceId="nabu.utils.Server.getServerName"
				resultName="result9499befa2b8f40779425dcb12af9abf8"
				temporaryMapping="true"
				x="4"
				y="63"
				invocationOrder="0"
				asynchronous="false"
				recache="false">
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
				disabled="false"
				id="e6d3c4cc-5509-4bdc-bf48-7d046020bb0c"
				serviceId="nabu.utils.Server.getServerGroup"
				resultName="result45010fae5e634d1c9afde25e20385020"
				temporaryMapping="true"
				x="59"
				y="162"
				invocationOrder="0"
				asynchronous="false"
				recache="false">
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
				disabled="false"
				id="53e9a20d-adbb-4aca-9c1f-176bde111b95"
				serviceId="nabu.utils.List.addAll"
				resultName="result0d41a1442b9b478ea4bb0601a60e6639"
				temporaryMapping="true"
				x="585"
				y="170"
				invocationOrder="1"
				asynchronous="false"
				recache="false">
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="d389db86-2827-4824-83e1-3d4506245781"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>result96c659eee7274c8b8948491862d7b58e/aliases</from>
				<to>list</to>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="c845b3eb-c228-4b77-aa48-131650443f5e"
					mask="false"
					optional="false"
					fixedValue="true">
				<from>$any</from>
				<to>objects[0]</to>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="7355db11-7052-4f5a-8c14-2dfb1584bd2f"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>result9499befa2b8f40779425dcb12af9abf8/server</from>
				<to>objects[1]</to>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="11cd9b39-d259-4777-8cc3-6bda16d2c770"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>result45010fae5e634d1c9afde25e20385020/group</from>
				<to>objects[2]</to>
			</steps>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
				disabled="false"
				id="92959598-67c5-4e6b-89c8-9d60cdae3a40"
				serviceId="nabu.utils.Server.getServerAliases"
				resultName="result96c659eee7274c8b8948491862d7b58e"
				temporaryMapping="true"
				x="16"
				y="289"
				invocationOrder="0"
				asynchronous="false"
				recache="false">
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Link"
				disabled="false"
				id="7d3629e1-e820-467e-ad62-945e5951c14a"
				mask="false"
				optional="false"
				fixedValue="false">
			<from>result0d41a1442b9b478ea4bb0601a60e6639/list</from>
			<to>input/targets</to>
		</steps>
	</steps>
	<steps xsi:type="be.nabu.libs.services.vm.step.Map"
			disabled="false"
			id="da207ea8-963d-4c75-87d2-46daa7933eb7"
			label="input/transactionId = null"
			lineNumber="3">
		<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
				disabled="false"
				id="14d20b61-6bfc-401d-a5da-4e51346d1513"
				serviceId="nabu.utils.Transaction.start"
				resultName="result5061d92f1c7f4588a566e41928d678d0"
				temporaryMapping="true"
				x="29"
				y="52"
				invocationOrder="0"
				asynchronous="false"
				recache="false">
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Link"
				disabled="false"
				id="98d5049a-4669-499a-b3ba-82ed2833dfb6"
				mask="false"
				optional="false"
				fixedValue="false">
			<from>result5061d92f1c7f4588a566e41928d678d0/transactionId</from>
			<to>input/transactionId</to>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Link"
				disabled="false"
				id="b60e7b2c-8f63-4441-b7d4-694454a7fdf3"
				mask="false"
				optional="false"
				fixedValue="true">
			<from>true</from>
			<to>manage</to>
		</steps>
	</steps>
	<steps xsi:type="be.nabu.libs.services.vm.step.Map"
			comment="Set lock name and default executor"
			disabled="false"
			id="cfc08f97-30aa-4903-816e-0734f1aa1469"
			lineNumber="4">
		<steps xsi:type="be.nabu.libs.services.vm.step.Link"
				disabled="false"
				id="c687afcd-d39d-4c67-9d64-27e68e5f3acb"
				mask="false"
				optional="false"
				fixedValue="true">
			<from>="subscribe.queue." + input/queue/name</from>
			<to>lockName</to>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Link"
				disabled="false"
				id="3cf342ba-f8f9-4f32-947a-bfc0c0b1561e"
				mask="false"
				optional="true"
				fixedValue="true">
			<from>nabu.frameworks.tasks.artifacts.sharedExecutor</from>
			<to>input/queue/executor</to>
		</steps>
	</steps>
	<steps xsi:type="be.nabu.libs.services.vm.step.Map"
			comment="Get the overshoot capacity (in the future we might want to tune this per queue). Check description for more info"
			disabled="false"
			id="f46efe35d5be4c348e9fc9090b9c531c"
			lineNumber="5">
		<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
				disabled="false"
				id="dd838677f5d64d8da4ef18d881c5870a"
				serviceId="nabu.utils.Server.property"
				resultName="result7f3bf6609ddb4d058565852b42f73211"
				temporaryMapping="true"
				x="216"
				y="99"
				invocationOrder="0"
				asynchronous="false"
				recache="false">
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="69707bacb9a549cc8207fa8b2683a0b6"
					mask="false"
					optional="false"
					fixedValue="true">
				<from>tasks.overshoot</from>
				<to>key</to>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="f16d08cf046c47f0814a26d3f47ad3bf"
					mask="false"
					optional="false"
					fixedValue="true">
				<from>0.2</from>
				<to>defaultValue</to>
			</steps>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Link"
				disabled="false"
				id="5f3d45581e2345cfab0cb19afab2fb51"
				mask="false"
				optional="false"
				fixedValue="false">
			<from>result7f3bf6609ddb4d058565852b42f73211/value</from>
			<to>overshoot</to>
		</steps>
	</steps>
	<steps xsi:type="be.nabu.libs.services.vm.step.Sequence"
			comment="If we have an overshoot capacity, check the thread pool first if there is room"
			disabled="false"
			id="c8ab3a9c4ad04b8683cf1c7e53850a70"
			label="overshoot &gt;= 0"
			lineNumber="6">
		<steps xsi:type="be.nabu.libs.services.vm.step.Map"
				disabled="false"
				id="99bf541b1d694ca6add01d68ebe7aaaf"
				lineNumber="7">
			<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
					disabled="false"
					id="e15cfaeaf32c498aa008ed0726d8c5ee"
					serviceId="nabu.misc.executor.Services.getStatistics"
					resultName="result94099acff785450eb518e4e451460ce3"
					temporaryMapping="true"
					x="236"
					y="155"
					invocationOrder="0"
					asynchronous="false"
					recache="false">
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="c7d2fc7fe1b84cc1a7519351d98e933b"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>input/queue/executor</from>
					<to>executorId</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="8373de24c2af40ada97e43d8984ed51a"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>result94099acff785450eb518e4e451460ce3/statistics</from>
				<to>statistics</to>
			</steps>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Sequence"
				comment="We might not get statistics"
				disabled="false"
				id="4b21d32097724fea9d1d628146e6d7e6"
				label="statistics"
				lineNumber="8">
			<steps xsi:type="be.nabu.libs.services.vm.step.Map"
					comment="Calculate max capacity"
					disabled="false"
					id="28efa12cdf1a49f4bccc798de6a9cf10"
					lineNumber="9">
				<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
						disabled="false"
						id="b91370efe1c04227a5ec75e101f15ff6"
						serviceId="nabu.utils.Math.round"
						resultName="result526bf501c670440aace9d3cbf8dff09e"
						temporaryMapping="true"
						x="339"
						y="223"
						invocationOrder="0"
						asynchronous="false"
						recache="false">
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="e70000c94afe4a03b9d70988f5eb036a"
							mask="false"
							optional="false"
							fixedValue="true">
						<from>CEILING</from>
						<to>roundingMode</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="f2eddab0d1d641e9bf20e6ec04450c23"
							mask="false"
							optional="false"
							fixedValue="true">
						<from>=overshoot * statistics/maximumPoolSize</from>
						<to>value</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="dbef229ddd124b8e9b07ac070f3b2151"
							mask="false"
							optional="false"
							fixedValue="true">
						<from>0</from>
						<to>precision</to>
					</steps>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="08e9c8eef22e47a9a21cac316666096a"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>result526bf501c670440aace9d3cbf8dff09e/rounded</from>
					<to>overshootCapacity</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Break"
					disabled="false"
					id="041adcb217b2440ca8b8a4d47809c058"
					label="statistics/queueSize &gt;= overshootCapacity"
					lineNumber="10">
				<count>3</count>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Map"
					comment="Calculate max amount of tasks and actual amount of tasks"
					disabled="false"
					id="5e9be53353ed4402b361fd5514606373"
					lineNumber="11">
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="285b7e949ed24025b0169d6b54e0b74f"
						mask="false"
						optional="false"
						fixedValue="true">
					<from>=statistics/maximumPoolSize + overshootCapacity</from>
					<to>maxAmountOfTasks</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="92d0c6fe49bd4803967d44f14c40b27f"
						mask="false"
						optional="false"
						fixedValue="true">
					<from>=statistics/queueSize + statistics/activeThreads</from>
					<to>actualAmountOfTasks</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Map"
					comment="Calculate max amount of tasks to pickup"
					disabled="false"
					id="08b3e855d0004e068f54eafd34ca8e81"
					lineNumber="12">
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="19a2aea52a6b4b6aa8baefc5dc0f3423"
						mask="false"
						optional="false"
						fixedValue="true">
					<from>=maxAmountOfTasks - actualAmountOfTasks</from>
					<to>maxAmountOfTasksToPickup</to>
				</steps>
			</steps>
		</steps>
	</steps>
	<steps xsi:type="be.nabu.libs.services.vm.step.Switch"
			disabled="false"
			id="53a205ef-d977-42d7-93b4-d1309cb790a0"
			lineNumber="13"
			query="input/queue/concurrency">
		<steps xsi:type="be.nabu.libs.services.vm.step.Map"
				comment="We have a serial queue, we need a cluster lock"
				disabled="false"
				id="ba6f0a66-84c3-412f-a776-98c7496ec582"
				label="0"
				lineNumber="14">
			<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
					disabled="false"
					id="9037227b-0501-4590-a000-55e3d17c58ef"
					serviceId="nabu.utils.Lock.tryLock"
					resultName="result1e361f6a10c94723b12f5319cdfa6f00"
					temporaryMapping="true"
					x="46"
					y="94"
					invocationOrder="0"
					asynchronous="false"
					recache="false">
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="84da3a54-786e-4f8c-9763-93dc05838b3b"
						mask="false"
						optional="false"
						fixedValue="true">
					<from>false</from>
					<to>local</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="354254be-a6a3-4fad-84bf-4db3f50059e2"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>lockName</from>
					<to>name</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="6a015fb3-c5dd-469d-9e36-88155491b12f"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>input/transactionId</from>
					<to>transactionId</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="eea82157-f22b-4d82-ab6f-8494ab8cf07a"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>result1e361f6a10c94723b12f5319cdfa6f00/locked</from>
				<to>canSubscribe</to>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="f163bf5d-a385-4ede-90fc-432fcc8feb88"
					mask="false"
					optional="false"
					fixedValue="true">
				<from>1</from>
				<to>concurrency</to>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="6cc1a876-20f9-4df0-b75d-811c5015e72e"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>lockName</from>
				<to>clusterLock</to>
			</steps>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Map"
				disabled="false"
				id="d5a4e191-d092-4408-a97f-12191a702283"
				lineNumber="15">
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="76ea3ad5-db85-4cd8-8e61-701e28b666b5"
					mask="false"
					optional="false"
					fixedValue="true">
				<from>true</from>
				<to>canSubscribe</to>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="2d46d374-f5e1-46f9-be77-0323334c2e12"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>input/queue/concurrency</from>
				<to>concurrency</to>
			</steps>
		</steps>
	</steps>
	<steps xsi:type="be.nabu.libs.services.vm.step.Sequence"
			comment="Make sure we unlock the cluster lock"
			disabled="false"
			id="4236cc34-044a-4869-a694-d96b842497ed"
			label="canSubscribe"
			lineNumber="16">
		<steps xsi:type="be.nabu.libs.services.vm.step.Map"
				comment="If it is a serial queue and we have the lock, roll back any running tasks by other servers"
				disabled="true"
				id="c1bd17f9-acf9-4084-a74f-e35049e36cc1"
				label="input/queue/concurrency = 0"
				lineNumber="17">
			<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
					disabled="false"
					id="c10586ed-c001-4e8c-8b42-680b0e6acb1a"
					serviceId="nabu.frameworks.tasks.utils.queue.rollback"
					resultName="result97ab4d808033489e8ac14ae3e8b72df8"
					temporaryMapping="true"
					x="236"
					y="180"
					invocationOrder="1"
					asynchronous="false"
					recache="false">
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="b687447d-04ef-44e6-9809-8c3d7dfa2881"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>input/queue</from>
					<to>queue</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="ace2dcb6-f082-49b2-8854-859c8b03a651"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>input/connectionId</from>
					<to>connectionId</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="32fd9534-94f4-44c6-bfdf-fa0349cfea78"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>input/transactionId</from>
					<to>transactionId</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="d9d274b5-9212-4eb7-b99f-ec4c4f793087"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>result865471fa695a44b59d8e5bf38a384704/server</from>
					<to>notOwner</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
					disabled="false"
					id="3bf77682-6a7d-4532-bbe1-a7fb18f8426f"
					serviceId="nabu.utils.Server.getServerName"
					resultName="result865471fa695a44b59d8e5bf38a384704"
					temporaryMapping="true"
					x="62"
					y="47"
					invocationOrder="0"
					asynchronous="false"
					recache="false">
			</steps>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Map"
				disabled="false"
				id="3f302815-a8d8-4ac2-9d9b-f34b6f173bac"
				label="input/queue/affix != null"
				lineNumber="18">
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="9c5309e0-63c0-4e5b-a867-981b81a057ba"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>input/queue/affix</from>
				<to>affix/affix</to>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
					disabled="false"
					id="e3023c30-42c8-4e0d-adaa-71cb75f6b93d"
					serviceId="nabu.utils.String.split"
					resultName="resultd3b8fb9e88bd48d787337f6570feda0c"
					temporaryMapping="true"
					x="192"
					y="333"
					invocationOrder="0"
					asynchronous="false"
					recache="false">
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="fcf24b2c-5297-41c4-b312-6ce95ea6faec"
						mask="false"
						optional="false"
						fixedValue="true">
					<from>tasks,task_logs,task_properties</from>
					<to>string</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="0516aec6-a1ab-4472-942a-5a7e97e60c52"
						mask="false"
						optional="false"
						fixedValue="true">
					<from>,</from>
					<to>separator</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="03bc3f4a-7e6f-47f8-9a72-8b2367e28e8e"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>resultd3b8fb9e88bd48d787337f6570feda0c/parts</from>
				<to>affix/tables</to>
			</steps>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Map"
				comment="Get amount of running tasks"
				disabled="false"
				id="9855a797-7b05-4483-a6b3-c6ec6c32e554"
				lineNumber="19">
			<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
					disabled="false"
					id="8816775e-f2c5-4a97-b4a4-2f902f1c71df"
					serviceId="nabu.frameworks.tasks.database.task.countByQueueId"
					resultName="result3a4da29d10ad4dce8280cf298ef00d6f"
					temporaryMapping="true"
					x="304"
					y="225"
					invocationOrder="1"
					asynchronous="false"
					recache="false">
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="f13b4f0d-3244-40a5-a765-314c579d1c30"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>input/connectionId</from>
					<to>connection</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="3e71792b-b84c-4a32-b0d4-86ce4ccf9a94"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>input/transactionId</from>
					<to>transaction</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="9219b7d7-fd69-4cc8-b020-9e574f965ec8"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>input/queue/id</from>
					<to>parameters/queueId</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="0450af0e-0ec5-4ad8-8e7c-2ce1be9af997"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>resulta92b243bc1864fd7bf08d3fa866f11d4/parts</from>
					<to>parameters/states</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="8fcdb4e9-8b9c-4cb3-b482-85e4ad769136"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>affix</from>
					<to>affix[0]</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="69e03ccdc69d4432a5514d99545de3a8"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>input/taskType</from>
					<to>parameters/taskType[0]</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
					disabled="false"
					id="b91ab2b3-6298-44d0-8df1-3f180e4c4241"
					serviceId="nabu.utils.String.split"
					resultName="resulta92b243bc1864fd7bf08d3fa866f11d4"
					temporaryMapping="true"
					x="80"
					y="60"
					invocationOrder="0"
					asynchronous="false"
					recache="false">
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="524dc6f4-d1bd-4044-bd61-565dc636e40e"
						mask="false"
						optional="false"
						fixedValue="true">
					<from>WAITING,RUNNING</from>
					<to>string</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="60a9dee3-5afd-4bce-a212-95a9f5fc3198"
						mask="false"
						optional="false"
						fixedValue="true">
					<from>,</from>
					<to>separator</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="a063b542-94f9-452e-b8f4-cdecd132ccd6"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>result3a4da29d10ad4dce8280cf298ef00d6f/results[0]/total</from>
				<to>amountOfRunningTasks</to>
			</steps>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Map"
				disabled="false"
				id="52006814-3899-44eb-a31d-a8dd83745c6f"
				label="amountOfRunningTasks &gt; 0"
				lineNumber="20">
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="5a3b76b5-4223-4cdb-8c4b-ae85e216efd6"
					mask="false"
					optional="false"
					fixedValue="true">
				<from>=concurrency - amountOfRunningTasks</from>
				<to>concurrency</to>
			</steps>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Map"
				disabled="false"
				id="f78c54c470ac469d8aabce6983385dac"
				label="maxAmountOfTasksToPickup != null"
				lineNumber="21">
			<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
					disabled="false"
					id="0a751972400049da9a7c0c86bf1e4fbb"
					serviceId="nabu.utils.List.minimum"
					resultName="result3ddbed4bd3e24880b45b28c244c415f7"
					temporaryMapping="true"
					x="202"
					y="246"
					invocationOrder="0"
					asynchronous="false"
					recache="false">
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="4249e3665b9440b581308f772e32235a"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>concurrency</from>
					<to>list[0]</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="1d952ec67ce54b22919b6813400f2832"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>maxAmountOfTasksToPickup</from>
					<to>list[1]</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="a1c1310f02c74056929d85d4adb4bf1e"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>result3ddbed4bd3e24880b45b28c244c415f7/minimum</from>
				<to>concurrency</to>
			</steps>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Sequence"
				comment="Only proceed if we want more tasks"
				disabled="false"
				id="8e4ac11e-6135-48e5-9f7c-49e58fb7034f"
				label="concurrency &gt; 0"
				lineNumber="22">
			<steps xsi:type="be.nabu.libs.services.vm.step.Map"
					comment="We already have a local lock, no need for a new lock and only one task"
					disabled="false"
					id="ffe1fa41-48a6-4ed8-b2bd-306bdae382cf"
					label="input/localLock != null"
					lineNumber="23">
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="e6206a23-db25-4156-a4ea-1d2a1547df0f"
						mask="false"
						optional="false"
						fixedValue="true">
					<from>1</from>
					<to>concurrency</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Map"
					comment="Poll tasks for the queue"
					disabled="false"
					id="60f52202-e45b-4edc-bb6b-d68beafb4b99"
					lineNumber="24">
				<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
						disabled="false"
						id="a7c37664-b00c-4eeb-b92e-875e98b8245f"
						serviceId="nabu.frameworks.tasks.utils.queue.poll"
						resultName="result42f527826a0f4e9aae5139b28f6443f5"
						temporaryMapping="true"
						x="70"
						y="125"
						invocationOrder="0"
						asynchronous="false"
						recache="false">
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="c87d8e0a-4f2d-45b7-911a-6f3c60dda1d1"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>concurrency</from>
						<to>limit</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="cd36f3ae-3cb5-4434-b75f-91aeaf67c935"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>input/targets</from>
						<to>targets</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="c362f561-a73c-4815-aa56-4580fdafbff6"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>input/taskType</from>
						<to>taskType</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="7b40d6fd-050a-4324-a2a3-ab6cbd3340e1"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>input/connectionId</from>
						<to>connectionId</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="f1a7d2e4-8827-4810-9fce-b75e0162cfde"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>input/transactionId</from>
						<to>transactionId</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="789b05a0-edb3-4f3c-bfcd-8aad149701ef"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>input/queue</from>
						<to>queue</to>
					</steps>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="baac70d1-d2e0-42e2-aeb9-c6b3f43aee2c"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>result42f527826a0f4e9aae5139b28f6443f5/tasks</from>
					<to>tasks</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="f45f5807-339e-4663-a840-8fdb10782c39"
						mask="false"
						optional="false"
						fixedValue="true">
					<from>0</from>
					<to>taskIndex</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
						disabled="false"
						id="a61e0fc0-219e-4c93-84c2-b3db5d5cd7b1"
						serviceId="nabu.utils.List.size"
						resultName="result6c7b6c39917845ee82d9ec9a8e8afd87"
						temporaryMapping="true"
						x="202"
						y="246"
						invocationOrder="1"
						asynchronous="false"
						recache="false">
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="d74d878d-1899-4975-b351-f08109739014"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>result42f527826a0f4e9aae5139b28f6443f5/tasks</from>
						<to>list</to>
					</steps>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="5ba6bccf-5b16-4c63-b682-e99b7ee64d69"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>result6c7b6c39917845ee82d9ec9a8e8afd87/size</from>
					<to>amountOfTasks</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="eceff012-97ff-4e5d-ba59-aa6125013895"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>result42f527826a0f4e9aae5139b28f6443f5/tasks</from>
					<to>output/tasks</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.For"
					disabled="false"
					id="0909cf3a-e680-4e45-b95e-1c778e3b2fae"
					label="amountOfTasks &gt; 0"
					lineNumber="25"
					variable="currentTask">
				<steps xsi:type="be.nabu.libs.services.vm.step.Break"
						comment="Stop if we have no more tasks left"
						disabled="true"
						id="d7ed6891-f1aa-48d1-84e0-cba22e716872"
						label="taskIndex &gt;= amountOfTasks"
						lineNumber="26">
					<count>1</count>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Sequence"
						disabled="true"
						id="80808c81-eb6b-4a35-b4e2-ee9a40af4ed1"
						label="canSubscribe"
						lineNumber="27">
					<steps xsi:type="be.nabu.libs.services.vm.step.Sequence"
							comment="Update task to WAITING"
							disabled="false"
							id="0d814432-9417-480e-aa4b-5c67bbeac1db"
							lineNumber="28"
							transactionVariable="waitingTransactionId">
						<steps xsi:type="be.nabu.libs.services.vm.step.Map"
								comment="Set to waiting"
								disabled="false"
								id="ad3cf9bd-4806-408f-a803-211d5c919c5d"
								lineNumber="29">
							<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
									disabled="false"
									id="3095c203-47da-4e66-9859-8f667a7f4e41"
									serviceId="nabu.frameworks.tasks.database.task.pickup"
									resultName="resultfcd0f6e8ace34345971fe60c4a056852"
									temporaryMapping="true"
									x="456"
									y="36"
									invocationOrder="1"
									asynchronous="false"
									recache="false">
								<steps xsi:type="be.nabu.libs.services.vm.step.Link"
										disabled="false"
										id="c214800d-11b5-4dd4-aa7f-36e4cae4aacc"
										mask="false"
										optional="false"
										fixedValue="false">
									<from>input/connectionId</from>
									<to>connection</to>
								</steps>
								<steps xsi:type="be.nabu.libs.services.vm.step.Link"
										disabled="false"
										id="7e8dca40-3566-4b5f-a105-7d7cbcb1e85d"
										mask="false"
										optional="false"
										fixedValue="false">
									<from>waitingTransactionId</from>
									<to>transaction</to>
								</steps>
								<steps xsi:type="be.nabu.libs.services.vm.step.Link"
										disabled="false"
										id="c40319ed-743e-40b1-8cb6-57810850f1dc"
										mask="false"
										optional="false"
										fixedValue="false">
									<from>tasks[/taskIndex]/id</from>
									<to>parameters[0]/id</to>
								</steps>
								<steps xsi:type="be.nabu.libs.services.vm.step.Link"
										disabled="false"
										id="069cdb01-40c4-4a62-a0b5-8ce21c010a42"
										mask="false"
										optional="false"
										fixedValue="false">
									<from>resultbd8bb666d22548938098668c33b51228/server</from>
									<to>parameters[0]/owner</to>
								</steps>
								<steps xsi:type="be.nabu.libs.services.vm.step.Link"
										disabled="false"
										id="0dbe822e-e76c-44a8-90b7-18fd6f454b66"
										mask="false"
										optional="false"
										fixedValue="false">
									<from>resultfc60faec495e4871868e98d55b3672cc/date</from>
									<to>parameters[0]/now</to>
								</steps>
								<steps xsi:type="be.nabu.libs.services.vm.step.Link"
										disabled="false"
										id="8577664f-cf85-41e3-8528-085fe221cc44"
										mask="false"
										optional="false"
										fixedValue="false">
									<from>affix</from>
									<to>affix[0]</to>
								</steps>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
									disabled="false"
									id="85365d97-9e0c-400c-9fb1-2f280a90c9c8"
									serviceId="nabu.utils.Server.getServerName"
									resultName="resultbd8bb666d22548938098668c33b51228"
									temporaryMapping="true"
									x="17"
									y="17"
									invocationOrder="0"
									asynchronous="false"
									recache="false">
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
									disabled="false"
									id="0049ecf5-21b2-458c-adc4-1527ac44d084"
									serviceId="nabu.utils.Date.now"
									resultName="resultfc60faec495e4871868e98d55b3672cc"
									temporaryMapping="true"
									x="22"
									y="421"
									invocationOrder="0"
									asynchronous="false"
									recache="false">
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="2fc4da54-dcdc-466d-bbe8-6b7a3ff04d15"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>resultfcd0f6e8ace34345971fe60c4a056852/rowCount</from>
								<to>waitingCount</to>
							</steps>
						</steps>
						<steps xsi:type="be.nabu.libs.services.vm.step.Map"
								disabled="false"
								id="e22f6400-1c26-49a1-a65c-fa50cb794af9"
								label="waitingCount &gt; 0"
								lineNumber="30">
							<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
									disabled="false"
									id="22fcef0f-3870-4ed6-b27a-114a3918b997"
									serviceId="nabu.frameworks.tasks.services.task.log"
									resultName="result28f5b46dd59c4385864672b49c955a87"
									temporaryMapping="true"
									x="252"
									y="122"
									invocationOrder="0"
									asynchronous="false"
									recache="false">
								<steps xsi:type="be.nabu.libs.services.vm.step.Link"
										disabled="false"
										id="0b9a72ae-1767-44b7-b8fb-81e1816cf197"
										mask="false"
										optional="false"
										fixedValue="false">
									<from>input/connectionId</from>
									<to>connectionId</to>
								</steps>
								<steps xsi:type="be.nabu.libs.services.vm.step.Link"
										disabled="false"
										id="8c6867d1-79af-4046-aef9-4ab8af1b978c"
										mask="false"
										optional="false"
										fixedValue="false">
									<from>waitingTransactionId</from>
									<to>transactionId</to>
								</steps>
								<steps xsi:type="be.nabu.libs.services.vm.step.Link"
										disabled="false"
										id="75516683-0d3c-4ee2-bb92-d5ce1142c91e"
										mask="false"
										optional="false"
										fixedValue="false">
									<from>tasks[/taskIndex]/id</from>
									<to>taskId</to>
								</steps>
								<steps xsi:type="be.nabu.libs.services.vm.step.Link"
										disabled="false"
										id="31481c00-9a5c-4ffe-85b6-104927a3aca2"
										mask="false"
										optional="false"
										fixedValue="true">
									<from>pickup</from>
									<to>code</to>
								</steps>
								<steps xsi:type="be.nabu.libs.services.vm.step.Link"
										disabled="false"
										id="ef4449a8-e5be-4dd3-9719-4c85652050c3"
										mask="false"
										optional="false"
										fixedValue="true">
									<from>Picked up task for processing</from>
									<to>title</to>
								</steps>
								<steps xsi:type="be.nabu.libs.services.vm.step.Link"
										disabled="false"
										id="f558a346-cefb-46c9-9691-8c23516b4b90"
										mask="false"
										optional="false"
										fixedValue="false">
									<from>affix</from>
									<to>affix</to>
								</steps>
							</steps>
						</steps>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Map"
							comment="Execute the task and increment taskIndex"
							disabled="false"
							id="d3322a32-793d-432e-9707-fe686906ee1f"
							label="waitingCount &gt; 0"
							lineNumber="31">
						<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
								disabled="false"
								id="556236bc-3558-4226-8a3f-98250f9d427f"
								serviceId="nabu.frameworks.tasks.utils.task.execute"
								resultName="result9f44565aab164352a7db2e1e7e537e8d"
								temporaryMapping="true"
								x="13"
								y="15"
								invocationOrder="0"
								target="=input/queue/executor"
								asynchronous="true"
								recache="false">
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="0b8bc744-f3fb-4889-aca2-eeb39104df76"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>tasks[/taskIndex]</from>
								<to>task</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="951a3f4a-f454-41d6-aac3-75582562219f"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>currentLockName</from>
								<to>localLock</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="03bb749d-b8aa-4aec-b49b-63fb6c35615f"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>input/connectionId</from>
								<to>connectionId</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="34d5c22c-0971-4b7e-b142-feaa83ac9f3f"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>clusterLock</from>
								<to>clusterLock</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="8b1a0fa7-58cd-4d65-80c6-51c4e4f4fa2b"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>input/queue</from>
								<to>queue</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="eb7f926f-eca8-4858-9895-ec6291ef1185"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>input/targets</from>
								<to>targets</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="c31a28de-9a2e-4316-8e78-a465a1b4eea8"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>input/taskType</from>
								<to>taskType</to>
							</steps>
						</steps>
						<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
								disabled="false"
								id="7a608935-3f80-41e1-852c-2527ee728cae"
								serviceId="nabu.utils.List.add"
								resultName="result32593c0358734b2898540f00cfbd842b"
								temporaryMapping="true"
								x="146"
								y="269"
								invocationOrder="0"
								asynchronous="false"
								recache="false">
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="152e53f9-f1cc-4b72-94cf-927896411cf3"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>output/tasks</from>
								<to>list</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="ab9b3e7a-c729-4014-8f26-d675cc44e3e8"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>tasks[/taskIndex]</from>
								<to>object</to>
							</steps>
						</steps>
						<steps xsi:type="be.nabu.libs.services.vm.step.Link"
								disabled="false"
								id="6d5aceb2-1d17-4685-bb8a-91ebcd210bf2"
								mask="false"
								optional="false"
								fixedValue="false">
							<from>result32593c0358734b2898540f00cfbd842b/list</from>
							<to>output/tasks</to>
						</steps>
						<steps xsi:type="be.nabu.libs.services.vm.step.Link"
								disabled="false"
								id="9f07ef47-9b3f-4d0d-9585-a90a2338097a"
								mask="false"
								optional="false"
								fixedValue="true">
							<from>=taskIndex + 1</from>
							<to>taskIndex</to>
						</steps>
					</steps>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Switch"
						disabled="false"
						id="c663fe3f-2332-4af7-9c72-29589fd2efeb"
						lineNumber="32"
						query="input/queue/concurrency">
					<steps xsi:type="be.nabu.libs.services.vm.step.Map"
							comment="When serial, don't offload to thread pool"
							disabled="false"
							id="e859f34a-f318-4202-a70c-3dcae6cae964"
							label="0"
							lineNumber="33">
						<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
								disabled="false"
								id="7775268e-bdc8-43e6-acde-934a2ffac79d"
								serviceId="nabu.frameworks.tasks.utils.queue.startTaskExecution"
								resultName="result1671defb009f4afab972957c3892d404"
								temporaryMapping="true"
								x="81"
								y="74"
								invocationOrder="0"
								asynchronous="false"
								recache="false">
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="8407cf0b-a8e5-4749-9fad-bae9156d4fea"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>input/connectionId</from>
								<to>connectionId</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="1c2550bd-96be-4402-9394-92b8c4b52ef8"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>input/queue</from>
								<to>queue</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="f1191019-b79e-43ac-a0cc-a81462807185"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>input/targets</from>
								<to>targets</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="9e85854b-fd4b-4ea8-b3e2-73c7f0a0576b"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>input/taskType</from>
								<to>taskType</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="904b2401-ee0d-43b8-bc8f-252694eaa577"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>affix</from>
								<to>affix</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="4d6f5aaf-ac5c-468e-bd8a-649f6148e933"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>currentTask</from>
								<to>task</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="b1c1ff78-5fc7-406d-9b57-be3a1f56d87b"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>currentLockName</from>
								<to>localLock</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="b1e98600-3807-4db6-8f69-88fe2016265f"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>clusterLock</from>
								<to>clusterLock</to>
							</steps>
						</steps>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Map"
							comment="When concurrent queues are used, spin off the task subscription to separate threads. Otherwise this becomes a bottleneck for high speed queues"
							disabled="false"
							id="4ddcbec9dd014ba89b94535eac4f247b"
							lineNumber="34">
						<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
								disabled="false"
								id="e132d410e1a543bc88b2e24d5ff0c13c"
								serviceId="nabu.frameworks.tasks.utils.queue.startTaskExecution"
								resultName="result1671defb009f4afab972957c3892d404"
								temporaryMapping="true"
								x="81"
								y="74"
								invocationOrder="0"
								target="nabu.frameworks.tasks.artifacts.sharedExecutor"
								asynchronous="true"
								recache="false">
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="72dd69f466014fd5b4468d24b59da79b"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>input/connectionId</from>
								<to>connectionId</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="e774f2669b2845999382f41b86a7b09d"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>input/queue</from>
								<to>queue</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="cbf56e367e4a43ddbf0ea980c0d2fd20"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>input/targets</from>
								<to>targets</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="e306a1682898475e8c3aa5f685a36e33"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>input/taskType</from>
								<to>taskType</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="26a245dfca8a46819a51d076f9d4268d"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>affix</from>
								<to>affix</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="249b9a35454044f1bee72b3b6fb58c1e"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>currentTask</from>
								<to>task</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="79721f9d4b084c01b9063ce86382b998"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>currentLockName</from>
								<to>localLock</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="c0075ae9a51e4c04afe99b1f65a62e10"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>clusterLock</from>
								<to>clusterLock</to>
							</steps>
						</steps>
					</steps>
				</steps>
				<query>tasks</query>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Map"
					comment="If no one is running anything, we can't pick anything new up _and_ the queue is set to published, finalize it"
					disabled="true"
					id="52765e99-a3d3-4f8b-932d-144b00fca6dc"
					label="amountOfRunningTasks == 0 &amp;&amp; amountOfTasks == 0 &amp;&amp; input/queue/published != null"
					lineNumber="35">
				<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
						disabled="false"
						id="abaa377f-a6b3-4e2d-ac95-7363bb9f428b"
						serviceId="nabu.frameworks.tasks.utils.queue.finalize"
						resultName="result7d1a311a2e3f4dd496066c808b93f5bb"
						temporaryMapping="true"
						x="77"
						y="27"
						invocationOrder="0"
						asynchronous="false"
						recache="false">
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="92ac751a-00b6-4443-b470-c25f310429ab"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>input/connectionId</from>
						<to>connectionId</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="5f1791cc-9764-4872-b24e-5ad95812d545"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>input/transactionId</from>
						<to>transactionId</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="c52e7c39-33c9-4c55-bbd9-f5071a7cd53a"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>input/queue</from>
						<to>queue</to>
					</steps>
				</steps>
			</steps>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Finally"
				disabled="false"
				id="18f313dc-9325-4a5f-8797-2a0731c04a86"
				lineNumber="36">
			<steps xsi:type="be.nabu.libs.services.vm.step.Map"
					comment="Release the cluster lock"
					disabled="false"
					id="00aa251e29e94008a90cf4dd214c219f"
					label="clusterLock != null"
					lineNumber="37">
				<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
						disabled="false"
						id="9fb85a8221864f67be7a290f2efef366"
						serviceId="nabu.utils.Lock.unlock"
						resultName="result9e46b3ae770243308a1fcf118d408830"
						temporaryMapping="true"
						x="36"
						y="108"
						invocationOrder="0"
						asynchronous="false"
						recache="false">
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="4bd646af65c9454291d59ab99dabd330"
							mask="false"
							optional="false"
							fixedValue="true">
						<from>false</from>
						<to>local</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="cc13883b-c440-430b-af3d-6759db7d5b4d"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>clusterLock</from>
						<to>name</to>
					</steps>
				</steps>
			</steps>
		</steps>
	</steps>
	<steps xsi:type="be.nabu.libs.services.vm.step.Map"
			disabled="false"
			id="f2646543-b8ab-4322-a13d-23056cbbaeac"
			label="manage"
			lineNumber="38">
		<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
				disabled="false"
				id="bc5c5f0e-6474-4588-aee6-14541c01669e"
				serviceId="nabu.utils.Transaction.commit"
				resultName="resultb5de570bbfa946bdbb7a796c779d9465"
				temporaryMapping="true"
				x="66"
				y="66"
				invocationOrder="0"
				asynchronous="false"
				recache="false">
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="d35c56ac-7739-4bf8-88b8-bb87a86cca85"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>input/transactionId</from>
				<to>transactionId</to>
			</steps>
		</steps>
	</steps>
	<steps xsi:type="be.nabu.libs.services.vm.step.Catch"
			disabled="false"
			id="b2a455da-3c0f-4777-b462-2a2c29945b61"
			lineNumber="39"
			variable="exception">
		<steps xsi:type="be.nabu.libs.services.vm.step.Map"
				disabled="false"
				id="2b0819a8277e40df8f0faaefbb689e69"
				label="manage"
				lineNumber="40">
			<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
					disabled="false"
					id="19411fd4-b5a0-490f-9ce4-a3abfee1158c"
					serviceId="nabu.utils.Transaction.rollback"
					resultName="result929732ee1d7445c4ac10a67717aa7017"
					temporaryMapping="true"
					x="22"
					y="23"
					invocationOrder="0"
					asynchronous="false"
					recache="false">
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="59dbb8cb-9569-40a3-85a4-462181040d52"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>input/transactionId</from>
					<to>transactionId</to>
				</steps>
			</steps>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Throw"
				disabled="false"
				id="3c30a983-c6ce-4d88-9a50-9e79c602483e"
				lineNumber="41"
				message="=exception"
				whitelist="false" xsi:nil="true"/>
	</steps>
</sequence>