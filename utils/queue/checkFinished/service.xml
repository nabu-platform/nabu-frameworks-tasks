<sequence xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" disabled="false" id="42948dbb-bc47-4e4b-9e33-ba3f5c9e9cc9">
	<steps xsi:type="be.nabu.libs.services.vm.step.Map" disabled="false" comment="Set lock name" id="7a2b16dc-3fb5-4f5f-92c0-936d4ca81b6a">
		<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="d8b1ef72-cb29-4466-b1fb-75a96ce27c85" fixedValue="true" optional="false" mask="false">
			<from>="finished.queue." + input/queue/name</from>
			<to>lockName</to>
		</steps>
	</steps>
	<steps xsi:type="be.nabu.libs.services.vm.step.Map" disabled="false" id="9a916502-5b62-422e-9a75-3efa8fb56c6b">
		<steps xsi:type="be.nabu.libs.services.vm.step.Invoke" disabled="false" id="671a80e7-6456-49d3-a464-9b15a9527728" serviceId="nabu.utils.Lock.lock" resultName="result51378ad7c53b48099a8df58df8569704" invocationOrder="0" temporaryMapping="true" y="44" x="48">
			<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="754b7d96-d399-4eca-83b0-c7e486776269" fixedValue="false" optional="false" mask="false">
				<from>lockName</from>
				<to>name</to>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="6e7ec53b-7f0e-4c68-a772-2a747261cdfa" fixedValue="true" optional="false" mask="false">
				<from>false</from>
				<to>local</to>
			</steps>
			<asynchronous>false</asynchronous>
		</steps>
	</steps>
	<steps xsi:type="be.nabu.libs.services.vm.step.Sequence" disabled="false" comment="Make sure we release the lock" id="e0a41dfd-81af-45b3-91e3-4a9fb3c38014">
		<steps xsi:type="be.nabu.libs.services.vm.step.Map" disabled="false" id="2f46bc34-e15a-4e97-9480-79cb97afa477">
			<steps xsi:type="be.nabu.libs.services.vm.step.Invoke" disabled="false" id="1d07587c-4c89-43c8-bf08-d9995bdc6d39" serviceId="nabu.frameworks.tasks.database.taskQueue.selectById" resultName="resultf3e4a5c995294df3822e90555ed4533a" invocationOrder="0" temporaryMapping="true" y="57" x="16">
				<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="0ceed00b-0854-435b-b99e-45cddcf0e64e" fixedValue="false" optional="false" mask="false">
					<from>input/connectionId</from>
					<to>connection</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="95468529-243f-47bf-8764-76c13be2adb2" fixedValue="false" optional="false" mask="false">
					<from>input/transactionId</from>
					<to>transaction</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="38784b8d-0edc-4ad6-8144-e390d48b4024" fixedValue="false" optional="false" mask="false">
					<from>input/queue/id</from>
					<to>parameters/id</to>
				</steps>
				<asynchronous>false</asynchronous>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="ce3e147a-6717-4d2e-9881-372c536b7bd7" fixedValue="false" optional="false" mask="false">
				<from>resultf3e4a5c995294df3822e90555ed4533a/results[0]</from>
				<to>queue</to>
			</steps>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Sequence" disabled="false" label="queue/published != null" comment="A queue can only be done if there is no more publishing to it" id="0624b84c-517a-4b69-b143-482776082fbb">
			<steps xsi:type="be.nabu.libs.services.vm.step.Map" disabled="false" comment="Get the amount of unfinished tasks" id="c6f78526-89b7-417c-b33a-23c3ee1c8cbd">
				<steps xsi:type="be.nabu.libs.services.vm.step.Invoke" disabled="false" id="57d76e69-5b61-4e2c-9ed9-b15085590fc5" serviceId="nabu.frameworks.tasks.database.task.countByQueueId" resultName="result6ade25488ee94a5eae61a7d3f922ecb4" invocationOrder="1" temporaryMapping="true" y="106" x="205">
					<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="ef32785f-6e27-4f69-88a9-2dbaa384d8fb" fixedValue="false" optional="false" mask="false">
						<from>input/connectionId</from>
						<to>connection</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="f334d837-549e-4e80-a7dc-f59ef140720c" fixedValue="false" optional="false" mask="false">
						<from>input/transactionId</from>
						<to>transaction</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="fd85232d-4b13-451a-879b-6fef53ade564" fixedValue="false" optional="false" mask="false">
						<from>queue/id</from>
						<to>parameters/queueId</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="8588ba21-8b4e-4c07-ac1d-3cd14f2e7537" fixedValue="false" optional="false" mask="false">
						<from>result28173c8bec994a4493ccedcaf5134327/parts</from>
						<to>parameters/states</to>
					</steps>
					<asynchronous>false</asynchronous>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Invoke" disabled="false" id="ff1f61b0-5898-4e04-88f3-28e7742023f2" serviceId="nabu.utils.String.split" resultName="result28173c8bec994a4493ccedcaf5134327" invocationOrder="0" temporaryMapping="true" y="10" x="35">
					<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="25c43271-ccc3-43d3-bf29-4eb6fdaae3ee" fixedValue="true" optional="false" mask="false">
						<from>WAITING,RUNNING,ERROR</from>
						<to>string</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="c706a96f-a1bf-49df-ab7b-c09e1d7e80f6" fixedValue="true" optional="false" mask="false">
						<from>,</from>
						<to>separator</to>
					</steps>
					<asynchronous>false</asynchronous>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="1c4ae6db-69d4-45f8-a203-d07dfc1076c7" fixedValue="false" optional="false" mask="false">
					<from>result6ade25488ee94a5eae61a7d3f922ecb4/results[0]/total</from>
					<to>amountOfTasks</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Sequence" disabled="false" label="amountOfTasks = 0" comment="If there are no more tasks remaining, it is officially done" id="1ff71fc8-8005-4b58-8316-9252eb983146">
				<steps xsi:type="be.nabu.libs.services.vm.step.Map" disabled="false" comment="Set the new state" id="532cf7fe-8a44-48ca-b8e3-f7ba35d9c83a">
					<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="5043835b-1415-4c1f-a1c0-823910e8ec1f" fixedValue="true" optional="false" mask="false">
						<from>FINISHED</from>
						<to>queue/state</to>
					</steps>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Map" disabled="false" comment="Update the queue and its dependencies" id="7d642d88-b06e-440e-9755-bf6e35639013">
					<steps xsi:type="be.nabu.libs.services.vm.step.Invoke" disabled="false" id="56343a95-5229-4d85-af54-b5dce1211aa8" serviceId="nabu.frameworks.tasks.database.taskQueue.update" resultName="resultd871fa02b6ad4a599f5b7e775f83c133" invocationOrder="0" temporaryMapping="true" y="44" x="38">
						<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="8004ead3-ca2a-43fd-a12a-d9b846737cfb" fixedValue="false" optional="false" mask="false">
							<from>queue</from>
							<to>parameters[0]</to>
						</steps>
						<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="e06c9dde-8b16-4099-a098-bd476001d878" fixedValue="false" optional="false" mask="false">
							<from>input/connectionId</from>
							<to>connection</to>
						</steps>
						<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="e9faad73-cac3-4683-bb15-f6d78e96b7f2" fixedValue="false" optional="false" mask="false">
							<from>input/transactionId</from>
							<to>transaction</to>
						</steps>
						<asynchronous>false</asynchronous>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Invoke" disabled="false" id="9b18779c-9c44-4938-a55b-0109b3f086a1" serviceId="nabu.frameworks.tasks.database.taskQueue.activateDependencies" resultName="resultecd12b759a994e668a94d6ab627fe894" invocationOrder="0" temporaryMapping="true" y="146" x="19">
						<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="3b562588-f37b-496f-b222-f7001262617a" fixedValue="false" optional="false" mask="false">
							<from>input/connectionId</from>
							<to>connection</to>
						</steps>
						<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="4a34154e-5155-41c1-aad3-8d9acd7fea75" fixedValue="false" optional="false" mask="false">
							<from>input/transactionId</from>
							<to>transaction</to>
						</steps>
						<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="0860d0f9-4979-4dae-aaac-6f39eefc23b0" fixedValue="false" optional="false" mask="false">
							<from>queue/id</from>
							<to>parameters[0]/queueId</to>
						</steps>
						<asynchronous>false</asynchronous>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="0cc072b4-3e71-4486-9837-162f44eb4ee7" fixedValue="false" optional="false" mask="false">
						<from>resultecd12b759a994e668a94d6ab627fe894/rowCount</from>
						<to>rowCount</to>
					</steps>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Map" disabled="false" label="rowCount &gt; 0" comment="If we activated a queue, make sure the task runner is active again" id="74485935-bbd7-4554-8eac-89c51b2a3140">
					<steps xsi:type="be.nabu.libs.services.vm.step.Invoke" disabled="false" id="32c758b1-496d-484d-b894-121a471a57b3" serviceId="nabu.utils.Runtime.interrupt" resultName="resultc2dc0e87a2c044fab41ad3e559dfb828" invocationOrder="0" temporaryMapping="true" y="77" x="29">
						<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="0e19c51d-15b1-4d1c-8c5e-aad5264ce30f" fixedValue="true" optional="false" mask="false">
							<from>nabu.frameworks.tasks.artifacts.taskChecker</from>
							<to>artifactId</to>
						</steps>
						<asynchronous>false</asynchronous>
						<target>$all</target>
					</steps>
				</steps>
			</steps>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Finally" disabled="false" id="8c233acc-1e5e-452f-a662-961f9fdbd938">
			<steps xsi:type="be.nabu.libs.services.vm.step.Map" disabled="false" id="23bae92d-6f86-4e68-84e3-482adbf40691">
				<steps xsi:type="be.nabu.libs.services.vm.step.Invoke" disabled="false" id="ea27cf6a-9319-4d51-96b1-22d561b5fd8d" serviceId="nabu.utils.Lock.unlock" resultName="result3683d1ff3780455aabed6b668255a700" invocationOrder="0" temporaryMapping="true" y="90" x="49">
					<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="756afa41-3857-44d5-921f-84329b5f95a8" fixedValue="false" optional="false" mask="false">
						<from>lockName</from>
						<to>name</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="8028d9bf-9a68-4f52-90da-cca124a69884" fixedValue="true" optional="false" mask="false">
						<from>false</from>
						<to>local</to>
					</steps>
					<asynchronous>false</asynchronous>
				</steps>
			</steps>
		</steps>
	</steps>
</sequence>